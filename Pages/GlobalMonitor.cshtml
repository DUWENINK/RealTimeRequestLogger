@page
@model GlobalMonitorModel
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <!-- æœ¬åœ° Tailwind CSS -->
    <link rel="stylesheet" href="~/css/tailwind.min.css">
    <style>
        /* è°ƒæ•´çš„æ ·å¼ */
        .log-container {
            height: calc(100vh - 200px); /* ä½¿è¡¨æ ¼å æ»¡å…¨å± */
            width: 100%;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }

        th {
            background-color: #edf2f7;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:nth-child(even) {
            background-color: #f7fafc;
        }

        tr:hover {
            background-color: #ebf8ff;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            border-radius: 5px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .btn-red {
            background-color: #e53e3e;
            color: white;
        }

            .btn-red:hover {
                background-color: #c53030;
            }

        .btn-blue {
            background-color: #3182ce;
            color: white;
        }

            .btn-blue:hover {
                background-color: #2b6cb0;
            }

        .btn {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* æ—¶é—´æˆ³æ ·å¼ */
        .timestamp {
            font-family: monospace;
            color: #718096;
        }

        /* æç¤ºæ¡†æ ·å¼ */
        .info-box {
            background-color: #e6fffa;
            border: 2px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #234e52;
        }

        .info-box h3 {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .info-box p {
            margin: 5px 0;
        }

    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto py-8">
        <h1 class="text-3xl font-bold text-center mb-8">å…¨å±€è¯·æ±‚ç›‘å¬ ğŸŒ</h1>

        <!-- è¯´æ˜ä¿¡æ¯ -->
        <div class="info-box">
            <h3>ğŸ“¡ å…¨å±€ç›‘å¬æ¨¡å¼</h3>
            <p>æ­¤é¡µé¢ä¼šå®æ—¶æ˜¾ç¤ºæ‰€æœ‰æ‰“å…¥ <code>http://your-ip:port/</code> çš„è¯·æ±‚(ä¸åŒ…æ‹¬å¸¦æœ‰ customKey å‚æ•°çš„è¯·æ±‚)</p>
            <p>ä½¿ç”¨ç¤ºä¾‹: <code>curl http://your-ip:port/api/test</code></p>
            <p>âŒ å¸¦ customKey çš„è¯·æ±‚ä¼šè¢«è¿‡æ»¤: <code>curl http://your-ip:port/api/test?customKey=xxx</code></p>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex justify-end mb-4 space-x-2">
            <button id="clearLogsBtn" class="btn btn-red">
                æ¸…ç©ºæ—¥å¿—
            </button>
            <button id="downloadLogsBtn" class="btn btn-blue">
                ä¸‹è½½æ—¥å¿—
            </button>
        </div>

        <!-- è¯·æ±‚æ—¥å¿—è¡¨æ ¼ -->
        <div class="bg-white shadow-md rounded-lg p-4 log-container">
            <table class="table-auto">
                <thead>
                    <tr>
                        <th>æ—¶é—´æˆ³</th>
                        <th>æ–¹æ³•</th>
                        <th>è·¯å¾„</th>
                        <th>æŸ¥è¯¢å­—ç¬¦ä¸²</th>
                        <th>è¯·æ±‚å¤´</th>
                        <th>è¯·æ±‚ä½“</th>
                    </tr>
                </thead>
                <tbody id="logTable" class="text-gray-600 text-sm font-light">
                    <!-- å®æ—¶æ•°æ®å°†è¢«æ’å…¥åˆ°è¿™é‡Œ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- æœ¬åœ° SignalR JS -->
    <script src="~/js/signalr.min.js"></script>
    <script type="text/javascript">
        let logData = [];
        let connection = null; // SignalR è¿æ¥å®ä¾‹

        document.addEventListener("DOMContentLoaded", function () {
            startSignalRConnection();
        });

        function startSignalRConnection() {
            // åˆå§‹åŒ–å¹¶è¿æ¥åˆ° SignalR
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/requestHub")
                .build();

            connection.start().then(function () {
                // æ³¨å†Œåˆ°å…¨å±€ç›‘å¬ç»„
                connection.invoke("RegisterGlobalMonitor");
                console.log("Connected to global monitor");
            }).catch(function (err) {
                return console.error(err.toString());
            });

            // å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚è¯¦æƒ…
            connection.on("ReceiveRequestDetails", function (message) {
                const logTable = document.getElementById("logTable");
                const timestamp = new Date().toLocaleTimeString();
                const lines = message.split("\n");
                const methodLine = lines.find(line => line.startsWith("Method:"));
                const pathLine = lines.find(line => line.startsWith("Path:"));
                const queryString = lines.find(line => line.startsWith("Query String:"));
                const headersLine = lines.slice(lines.indexOf("Headers:") + 1, lines.indexOf("Body:")).join("<br>");
                const bodyLine = lines.slice(lines.indexOf("Body:") + 1).join("<br>");

                const newRow = document.createElement("tr");
                newRow.className = "border-b border-gray-200 hover:bg-gray-100";
                newRow.innerHTML = `
                    <td class="timestamp">${timestamp}</td>
                    <td>${methodLine.replace("Method: ", "")}</td>
                    <td>${pathLine.replace("Path: ", "")}</td>
                    <td>${queryString ? queryString.replace("Query String: ", "") : ""}</td>
                    <td>${headersLine}</td>
                    <td>${bodyLine}</td>
                `;

                logTable.appendChild(newRow);

                // è®°å½•æ—¥å¿—
                logData.push({
                    timestamp,
                    method: methodLine.replace("Method: ", ""),
                    path: pathLine.replace("Path: ", ""),
                    queryString: queryString ? queryString.replace("Query String: ", "") : "",
                    headers: headersLine,
                    body: bodyLine
                });
            });
        }

        document.getElementById("clearLogsBtn").addEventListener("click", function () {
            document.getElementById("logTable").innerHTML = "";  // æ¸…ç©ºè¡¨æ ¼
            logData = [];  // æ¸…ç©ºæ—¥å¿—æ•°æ®
        });

        document.getElementById("downloadLogsBtn").addEventListener("click", function () {
            const blob = new Blob([JSON.stringify(logData, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "global-request-logs.json";
            link.click();
        });
    </script>
</body>
</html>
